<!DOCTYPE html>
<html lang="en-us">
<head>
    <title>blogging with style &middot; kalbasit</title>
    <meta name="generator" content="Hugo 0.47.1" />
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
    <meta name="author" content="Wael Nasreddine">
    
      <meta name="description" content="describing how I setup my blog with AWS, CoreOS and docker">
    
    
    <link rel="canonical" href="https://kalbas.it/2016/08/21/blogging-with-style/"/>
    <link rel="icon" href="https://kalbas.it/favicon.ico">
    <link rel="apple-touch-icon" href="https://kalbas.it/apple-touch-icon.png"/>
    <link rel="stylesheet" href="https://kalbas.it/css/style.css">
    <link rel="stylesheet" href="https://kalbas.it/css/font-awesome.min.css">
    <link rel="stylesheet" href="https://kalbas.it/css/monokai.css">
    <link rel="stylesheet" href="https://kalbas.it/fancybox/jquery.fancybox.css">
    
    <link href='https://fonts.googleapis.com/css?family=Open+Sans:400italic,400,600' rel='stylesheet' type='text/css'>
    <link href='https://fonts.googleapis.com/css?family=Source+Code+Pro' rel='stylesheet' type='text/css'>
    <meta property="og:title" content="blogging with style" />
<meta property="og:description" content="describing how I setup my blog with AWS, CoreOS and docker" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://kalbas.it/2016/08/21/blogging-with-style/" /><meta property="article:published_time" content="2016-08-21T18:21:02-07:00"/>
<meta property="article:modified_time" content="2016-08-21T18:21:02-07:00"/>
    
    
<meta itemprop="name" content="blogging with style">
<meta itemprop="description" content="describing how I setup my blog with AWS, CoreOS and docker">


<meta itemprop="datePublished" content="2016-08-21T18:21:02-07:00" />
<meta itemprop="dateModified" content="2016-08-21T18:21:02-07:00" />
<meta itemprop="wordCount" content="1472">



<meta itemprop="keywords" content="coreos,kubernetes,terraform,docker," />

    <meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="blogging with style"/>
<meta name="twitter:description" content="describing how I setup my blog with AWS, CoreOS and docker"/>
<meta name="twitter:site" content="@kalbasit"/>

    <link rel="stylesheet" href="https://kalbas.it/css/kalbas.it.css">


    

    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/2.1.4/jquery.min.js"></script>
</head>
<body>
<div class="container">


<div id="container">
	<header id="header">
  <div id="header-main" class="header-inner">
    <div class="outer">
      <a href="https://kalbas.it/" id="logo">
          
          <i class="logo" style="background-image: url('https://kalbas.it/images/logo.svg')"></i>
          
          <span class="site-title">kalbasit</span>
      </a>
      <nav id="main-nav">
          
          
          <a class="main-nav-link" href="https://kalbas.it/">Home</a>
          
          
          
          
          
          

          

          
          
          
          
          <a class="main-nav-link" href="https://kalbas.it/tags/">Tags</a>
          
          
          
          <a class="main-nav-link" href="https://kalbas.it/categories/">Categories</a>
          
          
      </nav>
        <nav id="sub-nav">
          <div class="profile" id="profile-nav">
            <a id="profile-anchor" href="javascript:;"><img class="avatar" src="https://kalbas.it/images/kalbasit.jpg"><i class="fa fa-caret-down"></i></a>
          </div>
        </nav>
        <div id="search-form-wrap">
          <form action="//google.com/search" method="get" accept-charset="UTF-8" class="search-form">
              <input type="search" name="q" class="search-form-input" placeholder="Search">
              <button type="submit" class="search-form-submit">
              </button>
              <input type="hidden" name="sitesearch" value="https://kalbas.it/" />
         </form>
        </div>
    </div>
  </div>
  <div id="main-nav-mobile" class="header-sub header-inner">
    <table class="menu outer">
      <tbody>
          <tr>
          
          
          <td><a class="main-nav-link" href="https://kalbas.it/">Home</a></td>
          
          
          
          
          
          

          

          
          
          
          
          <td><a class="main-nav-link" href="https://kalbas.it/tags/">Tags</a></td>
          
          
          
          <td><a class="main-nav-link" href="https://kalbas.it/categories/">Categories</a></td>
          
          
          <td>
          <form action="//google.com/search" method="get" accept-charset="UTF-8" class="search-form">
          <input type="search" name="q" class="search-form-input" placeholder="Search">
          <input type="hidden" name="sitesearch" value="https://kalbas.it/" />
          </form>
        </td>
      </tr>
      </tbody>
    </table>
  </div>
</header>

   	
   	<div class="outer">
   	
    	<aside id="profile">
  <div class="inner profile-inner">
    <div class="base-info profile-block">
      
      <img id="avatar" src="https://kalbas.it/images/kalbasit.jpg">
      
      <h2 id="name">Wael Nasreddine</h2>
      <h3 id="title">Entrepreneur - Engineer - Father</h3>
      <span id="location"><i class="fa fa-map-marker"></i>San Francisco Bay Area</span>
      
          <a id="follow" href="https://github.com/kalbasit">
              Follow
          </a>
      
    </div>
    <div class="article-info profile-block">
      <div class="article-info-block">
        1
        <span>Posts</span>
      </div>
      <div class="article-info-block">
        
          4
        
        <span>
            Tags
        </span>
      </div>
    </div>
    <div class="profile-block social-links">
      <table>
        <tr>
          
<td><a href="//github.com/kalbasit" target="_blank" title="GitHub"><i class="fa fa-github"></i></a></td>





































<td><a href="//linkedin.com/in/kalbasit" target="_blank" title="LinkedIn"><i class="fa fa-linkedin"></i></a></td>





<td><a href="//stackoverflow.com/users/301730" target="_blank" title="Stack Overflow"><i class="fa fa-stack-overflow"></i></a></td>



<td><a href="//reddit.com/user/kalbasit" target="_blank" title="Reddit"><i class="fa fa-reddit"></i></a></td>







<td><a href="//facebook.com/kalbasit" target="_blank" title="Facebook"><i class="fa fa-facebook"></i></a></td>



<td><a href="//twitter.com/kalbasit" target="_blank" title="Twitter"><i class="fa fa-twitter"></i></a></td>


          <td><a href="https://kalbas.it/index.xml" target="_blank" title="RSS"><i class="fa fa-rss"></i></a></td>
        </tr>
      </table>
    </div>
    
    <div class="profile-block hire-me">
      <a id="hireme" href="https://kalbas.it/hireme/">
        Hire Me!
      </a>
    </div>
    
  </div>
</aside>

    

    <section id="main">
    
    <article id="page-undefined" class="article article-type-page" itemscope="" itemprop="blogPost">
    <div class="article-inner">
        
            <img src="https://kalbas.it/images/posts/home-office-336378_640.jpg" class="article-banner">
        

        <header class="article-header">
    <a href="https://kalbas.it/2016/08/21/blogging-with-style/">
    <h1 class="article-title" itemprop="name">
        blogging with style
    </h1>
    </a>
    <div class="article-meta">

        
        <div class="article-date">
            <i class="fa fa-calendar"></i>
            <time datetime="2016-08-21 18:21:02 -0700 PDT" itemprop="datePublished">2016-08-21</time>
            &middot;
            1472
            words
            &middot;
            7
            minute read
        </div>
        
        
            
            
            <div class="article-category">
                <i class="fa fa-folder"></i>
                
                
                <a class="article-category-link" href="https://kalbas.it/categories/infrastructure">Infrastructure</a>
                
                
            </div>
            
        

        
            
            
            <div class="article-category">
                <i class="fa fa-tags"></i>
                
                
                <a class="article-category-link" href="https://kalbas.it/tags/coreos">coreos</a>
                &middot;
                
                
                <a class="article-category-link" href="https://kalbas.it/tags/kubernetes">kubernetes</a>
                &middot;
                
                
                <a class="article-category-link" href="https://kalbas.it/tags/terraform">terraform</a>
                &middot;
                
                
                <a class="article-category-link" href="https://kalbas.it/tags/docker">docker</a>
                
                
            </div>
            
        
    </div>
</header>

        
        <div id="toc">
          <nav id="TableOfContents">
<ul>
<li><a href="#overview">Overview</a></li>
<li><a href="#micro-containerized-cluster">Micro-Containerized cluster</a></li>
<li><a href="#the-blog">The blog</a></li>
<li><a href="#the-hosting">The hosting</a>
<ul>
<li><a href="#alternatives">Alternatives</a></li>
</ul></li>
<li><a href="#the-deployment">The deployment</a></li>
<li><a href="#the-server">The server</a>
<ul>
<li><a href="#how-to-update-the-server">How to update the server?</a></li>
</ul></li>
<li><a href="#cloud-provisioning">Cloud provisioning</a></li>
</ul>
</nav>
        </div>
        
        <div class="article-entry" itemprop="articleBody">
            <h1 id="overview">Overview</h1>

<p>It&rsquo;s been quite some time since I shared my knowledge and the daily
challenges that I overcome. I always wanted to get back into writing as
it has always been therapeutic for me.</p>

<p>Today, I&rsquo;m going to talk about how this blog is being hosted. We will
start from the top down by looking first at the application level, then
we will take a look at the hosting, the deployment, the server and
finally the cloud provisioning.</p>

<h1 id="micro-containerized-cluster">Micro-Containerized cluster</h1>

<p>The most ideal stack today would be:</p>

<ul>
<li>Etcd2 cluster with at least 5 nodes.</li>
<li>Kubernetes cluster with at least 3 master nodes and 2 minion nodes.</li>
<li>Let&rsquo;s encrypt generated SSL certificates for all websites.</li>
<li>Route53 for managing the DNS zones.</li>
<li>All managed using Terraform.</li>
</ul>

<p>That&rsquo;s exactly what I did for work, but it&rsquo;s way overkill and
financially unacceptable for a blog.</p>

<p>The stack I designed for this blog:</p>

<ul>
<li>One t2.micro instance running NginX containers with support for SSL
certificates from Let&rsquo;s encrypt.</li>
<li>Route53 for managing the DNS zones.</li>
<li>All managed using Terraform.</li>
</ul>

<p></p>

<h1 id="the-blog">The blog</h1>

<p>I wanted something I could easily customize, and does not use many
resources on the server. I thought of writing my own Go server to serve
static files but why <a href="https://github.com/search?utf8=%E2%9C%93&amp;q=%22static+site+generator%22&amp;type=Repositories&amp;ref=advsearch&amp;l=&amp;l=">re-invent the
wheel</a>?
<a href="https://github.com/jekyll/jekyll">Jekyll</a> is very popular but
<a href="https://gohugo.io/">Hugo</a> is much nicer, getting quite popular and get
few more points for being written in Go.</p>

<h1 id="the-hosting">The hosting</h1>

<p>Hosting a static website is quite common, there are many choices out
there but none of them offer a free SSL certificate from Let&rsquo;s Encrypt.</p>

<p>I&rsquo;m using <a href="https://hub.docker.com/r/library/nginx/">Nginx</a> container as
the server listening on HTTP and HTTPS.
<a href="https://hub.docker.com/r/jwilder/docker-gen/">docker-gen</a> watches for
containers exporting the variable <code>VIRTUAL_HOST</code>. <code>docker-gen</code> uses that
information to generate a configuration file for Nginx to listen on the
domain <code>VIRTUAL_HOST</code> is assigned and forward the requests to the
container exporting the <code>VIRTUAL_HOST</code>. Basically, the main Nginx
container is our reverse proxy and SSL terminating container.</p>

<p><a href="https://hub.docker.com/r/jrcs/letsencrypt-nginx-proxy-companion/">Let&rsquo;s encrypt Nginx proxy
container</a>
also watch containers exporting the variable <code>LETSENCRYPT_HOST</code> and
<code>LETSENCRYPT_EMAIL</code> to generate the SSL certificate via Let&rsquo;s Encrypt.</p>

<p>Here&rsquo;s all the systemd unit files for the hosting</p>

<p><code>nginx.service</code>:</p>

<pre><code>[Unit]
Description=The NGINX HTTP and reverse proxy server
Requires=docker.service data.mount
After=docker.service data.mount
[Service]
ExecStartPre=/bin/sh -c &quot;docker inspect nginx &gt;/dev/null 2&gt;&amp;1 &amp;&amp; docker rm -f nginx || true&quot;
ExecStartPre=/usr/bin/docker create --name nginx -p 80:80 -p 443:443 \
  -v /etc/nginx/conf.d \
  -v /etc/nginx/vhost.d \
  -v /usr/share/nginx/html \
  -v /data/nginx/certs:/etc/nginx/certs:ro \
  nginx
ExecStart=/usr/bin/docker start -a nginx
ExecStop=-/usr/bin/docker stop nginx
ExecStopPost=/usr/bin/docker rm -f nginx
Restart=on-failure
RestartSec=10
[Install]
WantedBy=multi-user.target
</code></pre>

<p><code>nginx-gen.service</code>:</p>

<pre><code>[Unit]
Description=Automatically generate nginx configuration for serving docker containers
Requires=docker.service nginx.service
After=docker.service nginx.service
[Service]
ExecStartPre=/bin/sh -c &quot;rm -f /tmp/nginx.tmpl &amp;&amp; curl -Lo /tmp/nginx.tmpl https://raw.githubusercontent.com/jwilder/nginx-proxy/a72c7e6e20df3738ca365bf6c14598f6a8017500/nginx.tmpl&quot;
ExecStartPre=/bin/sh -c &quot;docker inspect nginx-gen &gt;/dev/null 2&gt;&amp;1 &amp;&amp; docker rm -f nginx-gen || true&quot;
ExecStartPre=/usr/bin/docker create --name nginx-gen --volumes-from nginx \
	-v /tmp/nginx.tmpl:/etc/docker-gen/templates/nginx.tmpl:ro \
	-v /var/run/docker.sock:/tmp/docker.sock:ro \
	jwilder/docker-gen \
	-notify-sighup nginx -watch -only-exposed -wait 5s:30s \
	/etc/docker-gen/templates/nginx.tmpl /etc/nginx/conf.d/default.conf
ExecStart=/usr/bin/docker start -a nginx-gen
ExecStop=-/usr/bin/docker stop nginx-gen
ExecStopPost=/usr/bin/docker rm -f nginx-gen
Restart=on-failure
RestartSec=10
[Install]
WantedBy=multi-user.target
</code></pre>

<p><code>nginx-gen-letsencrypt.service</code>:</p>

<pre><code>[Unit]
Description=Automatically generate lets encrypt certificates
Requires=docker.service nginx-gen.service
After=docker.service nginx-gen.service
[Service]
ExecStartPre=/bin/sh -c &quot;docker inspect nginx-gen-letsencrypt &gt;/dev/null 2&gt;&amp;1 &amp;&amp; docker rm -f nginx-gen-letsencrypt || true&quot;
ExecStartPre=/usr/bin/docker create --name nginx-gen-letsencrypt -e &quot;NGINX_DOCKER_GEN_CONTAINER=nginx-gen&quot; --volumes-from nginx \
  -v /data/nginx/certs:/etc/nginx/certs:rw \
  -v /var/run/docker.sock:/var/run/docker.sock:ro \
  jrcs/letsencrypt-nginx-proxy-companion
ExecStart=/usr/bin/docker start -a nginx-gen-letsencrypt
ExecStop=-/usr/bin/docker stop nginx-gen-letsencrypt
ExecStopPost=/usr/bin/docker rm -f nginx-gen-letsencrypt
Restart=on-failure
RestartSec=10
[Install]
WantedBy=multi-user.target
</code></pre>

<p><code>nginx-provider.service</code>: This is only required to force the <code>nginx-gen</code>
to generate a valid configuration for <code>nginx</code> so <code>nginx</code> starts serving
the content provided by <code>nginx-gen-letsencrypt.service</code></p>

<pre><code>[Unit]
Description=Start the NginX provider
Requires=docker.service nginx-gen-letsencrypt.service
After=docker.service nginx-gen-letsencrypt.service
[Service]
ExecStartPre=/bin/sh -c &quot;docker inspect nginx-provider &gt;/dev/null 2&gt;&amp;1 &amp;&amp; docker rm -f nginx-provider || true&quot;
ExecStartPre=/usr/bin/docker create --name nginx-provider \
  -e VIRTUAL_HOST=http-only.kalbas.it nginx
ExecStart=/usr/bin/docker start -a nginx-provider
ExecStop=-/usr/bin/docker stop nginx-provider
ExecStopPost=/usr/bin/docker rm -f nginx-provider
Restart=on-failure
RestartSec=10
[Install]
WantedBy=multi-user.target
</code></pre>

<p>And finally, here&rsquo;s the systemd unit file running my blog:</p>

<pre><code>[Unit]
Description=The NGINX HTTP and reverse proxy server. For kalbas.it
Requires=docker.service nginx-provider.service
After=docker.service nginx-provider.service
[Service]
ExecStartPre=/bin/sh -c &quot;docker inspect nginx-kalbas.it &gt;/dev/null 2&gt;&amp;1 &amp;&amp; docker rm -f nginx-kalbas.it || true&quot;
ExecStartPre=/usr/bin/docker pull kalbasit/kalbas-it
ExecStartPre=/usr/bin/docker create --name nginx-kalbas.it \
  -e VIRTUAL_HOST=kalbas.it \
  -e LETSENCRYPT_HOST=kalbas.it \
  -e LETSENCRYPT_EMAIL=wael.nasreddine@gmail.com \
  kalbasit/kalbas-it
ExecStart=/usr/bin/docker start -a nginx-kalbas.it
ExecStop=-/usr/bin/docker stop nginx-kalbas.it
ExecStopPost=/usr/bin/docker rm -f nginx-kalbas.it
Restart=on-failure
RestartSec=10
[Install]
WantedBy=multi-user.target
</code></pre>

<p>You might have noticed that all the mounted volumes are mounted from
<code>/data</code>. I&rsquo;m using <a href="https://aws.amazon.com/efs/">Elastic File-system</a>
for the <code>/data</code> volume as I want to make sure that the new server
booting up can mount the same volume as the instance currently running.</p>

<h2 id="alternatives">Alternatives</h2>

<ul>
<li><a href="https://docs.aws.amazon.com/AmazonS3/latest/dev/WebsiteHosting.html">S3 Website Hosting</a>.</li>
<li>Few CDNs like <a href="https://aws.amazon.com/cloudfront/">CloudFront</a>.</li>
<li><a href="https://deciphertools.com/blog/google-app-engine-static-sites/">AppEngine</a>.</li>
</ul>

<p>All of them have their own Pros and Cons but none of them provides Let&rsquo;s
Encrypt possibility.</p>

<p><a href="https://github.com/mholt/caddy">Caddy</a> is a very promising server with
automatic Let&rsquo;s Encrypt support, but it <a href="https://github.com/mholt/caddy/issues/199">does not support automatic
docker container proxy as of
yet</a>.</p>

<p>I am considering switching my deployment to
<a href="https://github.com/containous/traefik">Traefik</a> as it does exactly what
my setup does but with less containers. It&rsquo;s also in Go!</p>

<h1 id="the-deployment">The deployment</h1>

<p>One of the best things I love about <a href="https://travis-ci.org">Travis-CI</a>,
is that it supports <a href="https://docs.travis-ci.com/user/deployment">native
deployments</a>. It supports
many providers but most importantly it supports a custom script.</p>

<p>At work, I&rsquo;ve built a <a href="https://github.com/publica-project/deploy-tools">deploy
script</a> that does the
following:
- Build a docker image, it requires <code>Rockerfile</code> rather than
  <code>Dockerfile</code> to allow me to build, tag and push the image.
- Deploy to Kubernetes cluster.</p>

<p>I have <a href="https://github.com/kalbasit/deploy-tools">forked the deploy
script</a> and added support for
deploying to a server by SSH&rsquo;ing to it, running <code>docker pull</code> on the
image and restarting the systemd service.</p>

<h1 id="the-server">The server</h1>

<p>It&rsquo;s no brainier today that CoreOS is the OS of choice when it comes to
a Web Server. The ideal setup would be a CoreOS cluster, to allow the
servers to roll a CoreOS update but again it&rsquo;s not economical. See <a href="#how-to-update-the-server">How
to update the server</a> below for
more details.</p>

<h2 id="how-to-update-the-server">How to update the server?</h2>

<p>I&rsquo;ve solved that by using an Elastic Load Balancer and have Terraform create an
instance before removing the current one and update the ELB with the new
instance ID.</p>

<h1 id="cloud-provisioning">Cloud provisioning</h1>

<p>I&rsquo;m using Terraform to provision AWS. The server itself is provisioned
via cloud-config.</p>

<p><code>web_server.tf</code>:</p>

<pre><code>resource &quot;aws_security_group&quot; &quot;web_server&quot; {
  name_prefix = &quot;web_server&quot;
  description = &quot;Allow HTTP, HTTPS and SSH from anywhere&quot;
  vpc_id      = &quot;${module.vpc_us-east-1.vpc_id}&quot;

  tags {
    Name    = &quot;web_server&quot;
    http    = &quot;yes&quot;
    https   = &quot;yes&quot;
    ssh     = &quot;yes&quot;
    self    = &quot;yes&quot;
    out_pub = &quot;yes&quot;
  }

  lifecycle {
    create_before_destroy = true
  }
}

resource &quot;aws_security_group_rule&quot; &quot;web_server-allow-all-from-self&quot; {
  type              = &quot;ingress&quot;
  from_port         = 0
  to_port           = 0
  protocol          = &quot;-1&quot;
  self              = true
  security_group_id = &quot;${aws_security_group.web_server.id}&quot;

  lifecycle {
    create_before_destroy = true
  }
}

resource &quot;aws_security_group_rule&quot; &quot;web_server-allow-ssh-from-all&quot; {
  type              = &quot;ingress&quot;
  from_port         = 22
  to_port           = 22
  protocol          = &quot;tcp&quot;
  cidr_blocks       = [&quot;0.0.0.0/0&quot;]
  security_group_id = &quot;${aws_security_group.web_server.id}&quot;

  lifecycle {
    create_before_destroy = true
  }
}

resource &quot;aws_security_group_rule&quot; &quot;web_server-allow-http-from-all&quot; {
  type              = &quot;ingress&quot;
  from_port         = 80
  to_port           = 80
  protocol          = &quot;tcp&quot;
  cidr_blocks       = [&quot;0.0.0.0/0&quot;]
  security_group_id = &quot;${aws_security_group.web_server.id}&quot;

  lifecycle {
    create_before_destroy = true
  }
}

resource &quot;aws_security_group_rule&quot; &quot;web_server-allow-https-from-all&quot; {
  type              = &quot;ingress&quot;
  from_port         = 443
  to_port           = 443
  protocol          = &quot;tcp&quot;
  cidr_blocks       = [&quot;0.0.0.0/0&quot;]
  security_group_id = &quot;${aws_security_group.web_server.id}&quot;

  lifecycle {
    create_before_destroy = true
  }
}

resource &quot;aws_security_group_rule&quot; &quot;web_server-allow-all-out&quot; {
  type              = &quot;egress&quot;
  cidr_blocks       = [&quot;0.0.0.0/0&quot;]
  from_port         = 0
  to_port           = 0
  protocol          = &quot;-1&quot;
  security_group_id = &quot;${aws_security_group.web_server.id}&quot;

  lifecycle {
    create_before_destroy = true
  }
}

resource &quot;aws_security_group&quot; &quot;web_server_data&quot; {
  name_prefix = &quot;web_server&quot;
  description = &quot;Allow HTTP, HTTPS and SSH from anywhere&quot;
  vpc_id      = &quot;${module.vpc_us-east-1.vpc_id}&quot;

  tags {
    Name = &quot;web_server_data&quot;
    nfs  = &quot;yes&quot;
  }

  lifecycle {
    create_before_destroy = true
  }
}

resource &quot;aws_security_group_rule&quot; &quot;web_server_data-allow-all-from-web-server&quot; {
  type                     = &quot;ingress&quot;
  from_port                = 0
  to_port                  = 0
  protocol                 = &quot;-1&quot;
  source_security_group_id = &quot;${aws_security_group.web_server.id}&quot;
  security_group_id        = &quot;${aws_security_group.web_server_data.id}&quot;

  lifecycle {
    create_before_destroy = true
  }
}

resource &quot;aws_efs_file_system&quot; &quot;web_server_data&quot; {
  tags {
    Name = &quot;web_server_data&quot;
    role = &quot;web_server_data&quot;
  }

  lifecycle {
    prevent_destroy = true
  }
}

resource &quot;aws_efs_mount_target&quot; &quot;web_server_data&quot; {
  count           = &quot;${length(var.public_subnets[&quot;us-east-1&quot;])}&quot;
  file_system_id  = &quot;${aws_efs_file_system.web_server_data.id}&quot;
  subnet_id       = &quot;${element(module.vpc_us-east-1.public_subnets, count.index)}&quot;
  security_groups = [&quot;${aws_security_group.web_server_data.id}&quot;]

  lifecycle {
    create_before_destroy = true
  }
}

// TODO(kalbasit): The `data` type does not support the count metadata as of
// Terraform v0.7.0. We will continue using the deperecated `resource` for
// `template_file` until the `data` supports it.
// See https://github.com/hashicorp/terraform/issues/7919
resource &quot;template_file&quot; &quot;web_server-cloud-config&quot; {
  count    = &quot;${length(var.public_subnets[&quot;us-east-1&quot;])}&quot;
  template = &quot;${file(&quot;${path.module}/templates/web_server-cloud-config.yml&quot;)}&quot;

  vars {
    web_server_data_dns_name = &quot;${element(aws_efs_mount_target.web_server_data.*.dns_name, count.index)}&quot;
  }

  lifecycle {
    create_before_destroy = true
  }
}

resource &quot;aws_instance&quot; &quot;web_server&quot; {
  count                  = 1
  ami                    = &quot;${data.aws_ami.coreos-stable.id}&quot;
  instance_type          = &quot;t2.micro&quot;
  vpc_security_group_ids = [&quot;${aws_security_group.web_server.id}&quot;]
  subnet_id              = &quot;${element(module.vpc_us-east-1.public_subnets, count.index)}&quot;
  user_data              = &quot;${element(template_file.web_server-cloud-config.*.rendered, count.index)}&quot;

  tags {
    Name = &quot;web_server-${count.index}&quot;
    role = &quot;web_server&quot;
  }

  lifecycle {
    create_before_destroy = true
  }
}

resource &quot;aws_elb&quot; &quot;web_server&quot; {
  name            = &quot;web-server&quot;
  subnets         = [&quot;${module.vpc_us-east-1.public_subnets}&quot;]
  security_groups = [&quot;${aws_security_group.web_server.id}&quot;]

  listener {
    instance_port     = &quot;80&quot;
    instance_protocol = &quot;tcp&quot;
    lb_port           = &quot;80&quot;
    lb_protocol       = &quot;tcp&quot;
  }

  listener {
    instance_port     = &quot;443&quot;
    instance_protocol = &quot;tcp&quot;
    lb_port           = &quot;443&quot;
    lb_protocol       = &quot;tcp&quot;
  }

  instances                   = [&quot;${aws_instance.web_server.*.id}&quot;]
  cross_zone_load_balancing   = true
  idle_timeout                = &quot;400&quot;
  connection_draining         = true
  connection_draining_timeout = &quot;400&quot;

  tags {
    Name = &quot;web_server&quot;
    role = &quot;lb&quot;
  }
}
</code></pre>
        </div>
        <footer class="article-footer">
    <a data-url="https://kalbas.it/2016/08/21/blogging-with-style/" data-id="c71482d6bd882cf4aa3b65784ae5a48f" class="article-share-link">
        <i class="fa fa-share"></i>
        Share
    </a>
    
    <a href="https://kalbas.it/2016/08/21/blogging-with-style/#disqus_thread" class="article-comment-link">
        Comments
    </a>
    

    <script>
    (function ($) {
        
        if (typeof(__SHARE_BUTTON_BINDED__) === 'undefined' || !__SHARE_BUTTON_BINDED__) {
            __SHARE_BUTTON_BINDED__ = true;
        } else {
            return;
        }
        $('body').on('click', function() {
            $('.article-share-box.on').removeClass('on');
        }).on('click', '.article-share-link', function(e) {
            e.stopPropagation();

            var $this = $(this),
                url = $this.attr('data-url'),
                encodedUrl = encodeURIComponent(url),
                id = 'article-share-box-' + $this.attr('data-id'),
                offset = $this.offset(),
                box;

            if ($('#' + id).length) {
                box = $('#' + id);

                if (box.hasClass('on')){
                    box.removeClass('on');
                    return;
                }
            } else {
                var html = [
                    '<div id="' + id + '" class="article-share-box">',
                        '<input class="article-share-input" value="' + url + '">',
                        '<div class="article-share-links">',
                            '<a href="https://twitter.com/intent/tweet?url=' + encodedUrl + '" class="fa fa-twitter article-share-twitter" target="_blank" title="Twitter"></a>',
                            '<a href="https://www.facebook.com/sharer.php?u=' + encodedUrl + '" class="fa fa-facebook article-share-facebook" target="_blank" title="Facebook"></a>',
                            '<a href="http://pinterest.com/pin/create/button/?url=' + encodedUrl + '" class="fa fa-pinterest article-share-pinterest" target="_blank" title="Pinterest"></a>',
                            '<a href="https://plus.google.com/share?url=' + encodedUrl + '" class="fa fa-google article-share-google" target="_blank" title="Google+"></a>',
                        '</div>',
                    '</div>'
                ].join('');

              box = $(html);

              $('body').append(box);
            }

            $('.article-share-box.on').hide();

            box.css({
                top: offset.top + 25,
                left: offset.left
            }).addClass('on');

        }).on('click', '.article-share-box', function (e) {
            e.stopPropagation();
        }).on('click', '.article-share-box-input', function () {
            $(this).select();
        }).on('click', '.article-share-box-link', function (e) {
            e.preventDefault();
            e.stopPropagation();

            window.open(this.href, 'article-share-box-window-' + Date.now(), 'width=500,height=450');
        });
    })(jQuery);
    </script>
</footer>

    </div>

    

</article>


<section id="comments">
    <div id="disqus_thread">
        <div id="disqus_thread"></div>
<script type="application/javascript">
    var disqus_config = function () {
    
    
    
    };
    (function() {
        if (["localhost", "127.0.0.1"].indexOf(window.location.hostname) != -1) {
            document.getElementById('disqus_thread').innerHTML = 'Disqus comments not available by default when the website is previewed locally.';
            return;
        }
        var d = document, s = d.createElement('script'); s.async = true;
        s.src = '//' + "kalbasit" + '.disqus.com/embed.js';
        s.setAttribute('data-timestamp', +new Date());
        (d.head || d.body).appendChild(s);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="https://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>
    </div>
</section>



    </section>

   	
    	<aside id="sidebar">
    
<div class="widget-wrap">
    <h3 class="widget-title">
        Recents
    </h3>
    <div class="widget">
        <ul id="recent-post">
            
            <li>
                <div class="item-thumbnail">
                    <a href="https://kalbas.it/2016/08/21/blogging-with-style/" class="thumbnail">
                    
                        <span style="background-image:url(https://kalbas.it/images/posts/home-office-336378_640.jpg)" alt="blogging with style" class="thumbnail-image"></span>
                    
                    </a>
                </div>
                <div class="item-inner">
                    
                    
                    <p class="item-category">
                        
                        <a class="article-category-link" href="https://kalbas.it/categories/infrastructure">
                        Infrastructure
                        </a>
                    </p>
                    
                    
                    <p class="item-title"><a href="https://kalbas.it/2016/08/21/blogging-with-style/" class="title">blogging with style</a></p>
                    <p class="item-date">
                        <time datetime="2016-08-21 18:21:02 -0700 PDT" itemprop="datePublished">2016-08-21</time>
                    </p>
                </div>
            </li>
            
        </ul>
    </div>
</div>


    


<div class="widget-wrap">
    <h3 class="widget-title">Categories</h3>
    <div class="widget">
        <ul class="category-list">
            
            <li class="category-list-item">
                
                <a class="category-list-link" href="https://kalbas.it/categories/infrastructure">
                    infrastructure
                </a>
                <span class="category-list-count">1</span>
            </li>
            
        </ul>
    </div>
</div>




    


<div class="widget-wrap">
    <h3 class="widget-title">
        Tags
    </h3>
    <div class="widget">
        <ul class="category-list">
            
            <li class="category-list-item">
                
                <a class="category-list-link" href="https://kalbas.it/tags/coreos">
                    coreos
                </a>
                <span class="category-list-count">1</span>
            </li>
            
            <li class="category-list-item">
                
                <a class="category-list-link" href="https://kalbas.it/tags/docker">
                    docker
                </a>
                <span class="category-list-count">1</span>
            </li>
            
            <li class="category-list-item">
                
                <a class="category-list-link" href="https://kalbas.it/tags/kubernetes">
                    kubernetes
                </a>
                <span class="category-list-count">1</span>
            </li>
            
            <li class="category-list-item">
                
                <a class="category-list-link" href="https://kalbas.it/tags/terraform">
                    terraform
                </a>
                <span class="category-list-count">1</span>
            </li>
            
        </ul>
    </div>
</div>




    


<div class="widget-wrap">
    <h3 class="widget-title">
        Tag cloud
    </h3>
    <div class="widget tagcloud">
        
        
        <a href="https://kalbas.it/tags/coreos" style="font-size: 12px;">coreos</a>
        
        
        <a href="https://kalbas.it/tags/docker" style="font-size: 12px;">docker</a>
        
        
        <a href="https://kalbas.it/tags/kubernetes" style="font-size: 12px;">kubernetes</a>
        
        
        <a href="https://kalbas.it/tags/terraform" style="font-size: 12px;">terraform</a>
        
    </div>
</div>





    <div id="toTop" class="fa fa-angle-up"></div>
</aside>

    
	</div>
</div>

<footer id="footer">
  <div class="outer">
    <div id="footer-info" class="inner">
      &copy; 2019
      Powered by <a href="//gohugo.io">Hugo</a>. Theme by <a href="http://github.com/ppoffice">PPOffice</a>.
    </div>
  </div>
</footer>


<script type="application/javascript">
var doNotTrack = false;
if (!doNotTrack) {
	(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
	(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
	m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
	})(window,document,'script','https://www.google-analytics.com/analytics.js','ga');
	ga('create', 'UA-82839578-2', 'auto');
	
	ga('send', 'pageview');
}
</script>

<script src="https://kalbas.it/fancybox/jquery.fancybox.pack.js"></script>
<script src="https://kalbas.it/js/script.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.9.0/highlight.min.js"></script>


<script>hljs.initHighlightingOnLoad();</script>


<script type="text/x-mathjax-config">
MathJax.Hub.Config({
  tex2jax: {
    inlineMath: [['$','$'], ['\\(','\\)']]}
  });
</script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>




</body>
</html>