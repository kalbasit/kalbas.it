<!DOCTYPE html>
<html lang="en">
<head>
  
    <title>Website with NixOS/NixOPS, with automated let&#39;s encrypt :: kalbasit — Wael Nasreddine</title>
  
  <meta http-equiv="content-type" content="text/html; charset=utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1">
<meta name="description" content="Overview Working with Let&amp;rsquo;s Encrypt can sometimes be quite difficult, especially when setting up your own load balancer in front of your application servers. This article give you a step by step instructions on how to create a server, running NixOS and managed by NixOPS.
System Design Let&amp;rsquo;s first talk about the sytem design of our load-balanced application. We want to run two replicas of a hello world application (written in Go), behind a load balancer running NginX."/>
<meta name="keywords" content=""/>
<meta name="robots" content="noodp"/>
<link rel="canonical" href="https://kalbas.it/2019/02/24/website-with-nixos-nixops-with-automated-lets-encrypt/" />


<link rel="stylesheet" href="https://kalbas.it/assets/style.css">



<link rel="stylesheet" href="https://kalbas.it/style.css">


<link rel="apple-touch-icon-precomposed" sizes="144x144" href="https://kalbas.it/img/apple-touch-icon-144-precomposed.png">

  <link rel="shortcut icon" href="https://kalbas.it/img/favicon/orange.png">



<meta name="twitter:card" content="summary" />
<meta name="twitter:title" content="Website with NixOS/NixOPS, with automated let&#39;s encrypt :: kalbasit — Wael Nasreddine" />
<meta name="twitter:description" content="Overview Working with Let&amp;rsquo;s Encrypt can sometimes be quite difficult, especially when setting up your own load balancer in front of your application servers. This article give you a step by step instructions on how to create a server, running NixOS and managed by NixOPS.
System Design Let&amp;rsquo;s first talk about the sytem design of our load-balanced application. We want to run two replicas of a hello world application (written in Go), behind a load balancer running NginX." />
<meta name="twitter:site" content="https://kalbas.it/" />
<meta name="twitter:creator" content="" />
<meta name="twitter:image" content="">


<meta property="og:locale" content="en" />
<meta property="og:type" content="article" />
<meta property="og:title" content="Website with NixOS/NixOPS, with automated let&#39;s encrypt :: kalbasit — Wael Nasreddine">
<meta property="og:description" content="Overview Working with Let&amp;rsquo;s Encrypt can sometimes be quite difficult, especially when setting up your own load balancer in front of your application servers. This article give you a step by step instructions on how to create a server, running NixOS and managed by NixOPS.
System Design Let&amp;rsquo;s first talk about the sytem design of our load-balanced application. We want to run two replicas of a hello world application (written in Go), behind a load balancer running NginX." />
<meta property="og:url" content="https://kalbas.it/2019/02/24/website-with-nixos-nixops-with-automated-lets-encrypt/" />
<meta property="og:site_name" content="Website with NixOS/NixOPS, with automated let&#39;s encrypt" />
<meta property="og:image" content="">
<meta property="og:image:width" content="2048">
<meta property="og:image:height" content="1024">
<meta property="article:section" content="Infrastructure" />
<meta property="article:published_time" content="2019-02-24 18:50:58 -0800 PST" />







</head>
<body class="">
<div class="container">
  <header class="header">
  <div class="header__inner">
    <div class="header__logo">
      <a href="/">
  <div class="logo">
    λ kalbas.it
  </div>
</a>

    </div>
    <div class="menu-trigger">menu</div>
  </div>
  
    <nav class="menu">
  <ul class="menu__inner menu__inner--desktop">
    
      
        
          <li><a href="/about">About</a></li>
        
      
      
    
  </ul>

  <ul class="menu__inner menu__inner--mobile">
    
      
        <li><a href="/about">About</a></li>
      
    
  </ul>
</nav>

  
</header>


  <div class="content">
    
  <div class="post">
    <h1 class="post-title"><a href="https://kalbas.it/2019/02/24/website-with-nixos-nixops-with-automated-lets-encrypt/">Website with NixOS/NixOPS, with automated let&rsquo;s encrypt</a></h1>
    <div class="post-meta">
      <span class="post-date">
        2019-02-24
      </span>
      
    </div>

    
      <span class="post-tags">
        
          #<a href="https://kalbas.it/tags/nix/">nix</a>&nbsp;
        
          #<a href="https://kalbas.it/tags/nixos/">nixos</a>&nbsp;
        
          #<a href="https://kalbas.it/tags/nixops/">nixops</a>&nbsp;
        
          #<a href="https://kalbas.it/tags/nginx/">nginx</a>&nbsp;
        
          #<a href="https://kalbas.it/tags/letsencrypt/">letsencrypt</a>&nbsp;
        
      </span>
    

    

    <div class="post-content">
      

<h1 id="overview">Overview</h1>

<p>Working with Let&rsquo;s Encrypt can sometimes be quite difficult, especially
when setting up your own load balancer in front of your application
servers. This article give you a step by step instructions on how to
create a server, running <a href="https://nixos.org">NixOS</a> and managed by
NixOPS.</p>

<h1 id="system-design">System Design</h1>

<p>Let&rsquo;s first talk about the sytem design of our load-balanced
application. We want to run two replicas of a hello world application
(written in Go), behind a load balancer running NginX.</p>


  <figure class="center" >
    <img src="/assets/images/post/nixos-lb-appserver/design.svg"   />
    
  </figure>



<h1 id="getting-ready">Getting ready</h1>

<p>Skip this step if you have already installed Nix and NixOPS.</p>

<h2 id="installing-nix">Installing Nix</h2>

<p>Nix can be installed by following the instructions
<a href="https://nixos.org/nix/download.html">here</a>. At the time of writing this
guide, Nix can be installed by simply running <code>curl
https://nixos.org/nix/install | sh</code> as a non-root user.</p>

<h2 id="installing-nixops">Installing NixOPS</h2>

<p>Once you have installed Nix, you can install nixops by running <code>nix-env
-f '&lt;nixpkgs&gt;' -iA nixops</code>.</p>

<h2 id="create-the-hello-world-application">Create the Hello World application</h2>

<p>This step guides you to create a hello world application in Go. It&rsquo;s
O.K. if you are not familiar with Go as we only use it here to write a
Hello, World web application.</p>

<p>Open up <code>hello-world/main.go</code> and type in the following contents:</p>


<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#f92672">package</span> <span style="color:#a6e22e">main</span>

<span style="color:#f92672">import</span> (
	<span style="color:#e6db74">&#34;fmt&#34;</span>
	<span style="color:#e6db74">&#34;html/template&#34;</span>
	<span style="color:#e6db74">&#34;log&#34;</span>
	<span style="color:#e6db74">&#34;net/http&#34;</span>
	<span style="color:#e6db74">&#34;os&#34;</span>
)

<span style="color:#66d9ef">func</span> <span style="color:#a6e22e">main</span>() {
	<span style="color:#a6e22e">http</span>.<span style="color:#a6e22e">HandleFunc</span>(<span style="color:#e6db74">&#34;/&#34;</span>, <span style="color:#a6e22e">rootHandler</span>)

	<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Println</span>(<span style="color:#e6db74">&#34;Serving on port :8080&#34;</span>)
	<span style="color:#a6e22e">log</span>.<span style="color:#a6e22e">Fatal</span>(<span style="color:#a6e22e">http</span>.<span style="color:#a6e22e">ListenAndServe</span>(<span style="color:#e6db74">&#34;:8080&#34;</span>, <span style="color:#66d9ef">nil</span>))
}

<span style="color:#66d9ef">func</span> <span style="color:#a6e22e">rootHandler</span>(<span style="color:#a6e22e">w</span> <span style="color:#a6e22e">http</span>.<span style="color:#a6e22e">ResponseWriter</span>, <span style="color:#a6e22e">r</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">http</span>.<span style="color:#a6e22e">Request</span>) {
	<span style="color:#a6e22e">host</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">os</span>.<span style="color:#a6e22e">Hostname</span>()
	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
		<span style="color:#a6e22e">log</span>.<span style="color:#a6e22e">Printf</span>(<span style="color:#e6db74">&#34;error getting the hostname: %s&#34;</span>, <span style="color:#a6e22e">err</span>)
		<span style="color:#a6e22e">http</span>.<span style="color:#a6e22e">Error</span>(<span style="color:#a6e22e">w</span>, <span style="color:#a6e22e">err</span>.<span style="color:#a6e22e">Error</span>(), <span style="color:#a6e22e">http</span>.<span style="color:#a6e22e">StatusInternalServerError</span>)
	}
	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">indexTemplate</span>.<span style="color:#a6e22e">Execute</span>(<span style="color:#a6e22e">w</span>, <span style="color:#66d9ef">struct</span>{ <span style="color:#a6e22e">Hostname</span> <span style="color:#66d9ef">string</span> }{<span style="color:#a6e22e">Hostname</span>: <span style="color:#a6e22e">host</span>}); <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
		<span style="color:#a6e22e">log</span>.<span style="color:#a6e22e">Printf</span>(<span style="color:#e6db74">&#34;error executing the index template: %s&#34;</span>, <span style="color:#a6e22e">err</span>)
		<span style="color:#a6e22e">http</span>.<span style="color:#a6e22e">Error</span>(<span style="color:#a6e22e">w</span>, <span style="color:#a6e22e">err</span>.<span style="color:#a6e22e">Error</span>(), <span style="color:#a6e22e">http</span>.<span style="color:#a6e22e">StatusInternalServerError</span>)
	}
}

<span style="color:#66d9ef">var</span> <span style="color:#a6e22e">indexTemplate</span> = <span style="color:#a6e22e">template</span>.<span style="color:#a6e22e">Must</span>(<span style="color:#a6e22e">template</span>.<span style="color:#a6e22e">New</span>(<span style="color:#e6db74">&#34;index.html&#34;</span>).<span style="color:#a6e22e">Parse</span>(<span style="color:#e6db74">`
</span><span style="color:#e6db74">&lt;!DOCTYPE html&gt;
</span><span style="color:#e6db74">&lt;html&gt;
</span><span style="color:#e6db74">	&lt;head&gt;
</span><span style="color:#e6db74">		&lt;title&gt;Load-balanced application&lt;/title&gt;
</span><span style="color:#e6db74">	&lt;/head&gt;
</span><span style="color:#e6db74">	&lt;body&gt;
</span><span style="color:#e6db74">		&lt;h1&gt;Hello, World!&lt;/h1&gt;
</span><span style="color:#e6db74">		&lt;p&gt;You are being serve this webpage from &lt;strong&gt;</span><span style="color:#75715e">{{</span> <span style="color:#a6e22e">.Hostname</span> <span style="color:#75715e">}}</span><span style="color:#e6db74">&lt;/strong&gt;.&lt;/p&gt;
</span><span style="color:#e6db74">	&lt;/body&gt;
</span><span style="color:#e6db74">&lt;/html&gt;
</span><span style="color:#e6db74">`</span>))
</code></pre></div>

<p>And create a <code>hello-world/default.nix</code> so we can deploy this application in NixOS.</p>


<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-nix" data-lang="nix">{ buildGoPackage<span style="color:#f92672">,</span> lib }:

buildGoPackage <span style="color:#66d9ef">rec</span> {
  name <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;hello-app-</span><span style="color:#e6db74">${</span>version<span style="color:#e6db74">}</span><span style="color:#e6db74">&#34;</span>;
  version <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;0.0.1&#34;</span>;

  <span style="color:#75715e"># The GOPATH is defined to satisfy buildGoPackage, but is not going to be</span>
  <span style="color:#75715e"># used as we do not define any packages here besides the main package</span>
  goPackagePath <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;github.com/kalbasit/kalbas.it/content/post/nixos-lb-appserver/hello-world&#34;</span>;

  src <span style="color:#f92672">=</span> <span style="color:#e6db74">./.</span>;

  meta <span style="color:#f92672">=</span> <span style="color:#66d9ef">with</span> lib; {
    description <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;Hello World HTTP application&#34;</span>;
    maintainers <span style="color:#f92672">=</span> <span style="color:#66d9ef">with</span> maintainers; [ kalbasit ];
    platforms <span style="color:#f92672">=</span> platforms<span style="color:#f92672">.</span>linux <span style="color:#f92672">++</span> platforms<span style="color:#f92672">.</span>darwin;
  };
}
</code></pre></div>

<h3 id="servers">Servers</h3>

<p>Define the servers we will be running for this demonstration by creating
the file <code>servers.nix</code> with the following content:</p>


<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-nix" data-lang="nix">{ pkgs <span style="color:#f92672">?</span> <span style="color:#f92672">import</span> <span style="color:#e6db74">&lt;nixpkgs&gt;</span> {}<span style="color:#f92672">,</span> domain <span style="color:#f92672">?</span> <span style="color:#e6db74">&#34;_&#34;</span> }:

<span style="color:#66d9ef">let</span>
  hello-world <span style="color:#f92672">=</span> pkgs<span style="color:#f92672">.</span>callPackage <span style="color:#e6db74">./hello-world</span> {};

  <span style="color:#75715e"># makeBackend is a function that returns the configuration for a host serving</span>
  <span style="color:#75715e"># the hello-world application.</span>
  makeBackend <span style="color:#f92672">=</span> {
    systemd<span style="color:#f92672">.</span>services<span style="color:#f92672">.</span>hello-world <span style="color:#f92672">=</span> {
      wantedBy <span style="color:#f92672">=</span> [ <span style="color:#e6db74">&#34;multi-user.target&#34;</span> ];
      restartIfChanged <span style="color:#f92672">=</span> <span style="color:#66d9ef">true</span>;
      serviceConfig <span style="color:#f92672">=</span> {
        ExecStart <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;</span><span style="color:#e6db74">${</span>pkgs<span style="color:#f92672">.</span>lib<span style="color:#f92672">.</span>getBin hello-world<span style="color:#e6db74">}</span><span style="color:#e6db74">/bin/hello-world&#34;</span>;
        RestartSec <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;5&#34;</span>;
        Restart <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;always&#34;</span>;
      };
    };

    networking<span style="color:#f92672">.</span>firewall<span style="color:#f92672">.</span>allowedTCPPorts <span style="color:#f92672">=</span> [ <span style="color:#ae81ff">8080</span> ];
  };

<span style="color:#66d9ef">in</span> {
  network<span style="color:#f92672">.</span>description <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;Load-balanced Hello World web application&#34;</span>;
  network<span style="color:#f92672">.</span>enableRollback <span style="color:#f92672">=</span> <span style="color:#66d9ef">true</span>;

  backend1 <span style="color:#f92672">=</span> makeBackend;
  backend2 <span style="color:#f92672">=</span> makeBackend;

  lb <span style="color:#f92672">=</span> {
    networking<span style="color:#f92672">.</span>firewall<span style="color:#f92672">.</span>allowedTCPPorts <span style="color:#f92672">=</span> [ <span style="color:#ae81ff">80</span> ];

    services<span style="color:#f92672">.</span>nginx <span style="color:#f92672">=</span> {
      enable <span style="color:#f92672">=</span> <span style="color:#66d9ef">true</span>;
      upstreams <span style="color:#f92672">=</span> {
        <span style="color:#e6db74">&#34;backend&#34;</span> <span style="color:#f92672">=</span> {
          servers <span style="color:#f92672">=</span> {
            <span style="color:#e6db74">&#34;backend1:8080&#34;</span> <span style="color:#f92672">=</span> {};
            <span style="color:#e6db74">&#34;backend2:8080&#34;</span> <span style="color:#f92672">=</span> {};
          };
        };
      };
      virtualHosts <span style="color:#f92672">=</span> {
        <span style="color:#e6db74">&#34;</span><span style="color:#e6db74">${</span>domain<span style="color:#e6db74">}</span><span style="color:#e6db74">&#34;</span> <span style="color:#f92672">=</span> {
          locations<span style="color:#f92672">.</span><span style="color:#e6db74">&#34;/&#34;</span> <span style="color:#f92672">=</span> {
            proxyPass <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;http://backend&#34;</span>;
          };
        };
      };
    };
  };
}
</code></pre></div>

<p>This file defines our backends, as well as the the load balancer node.
This definitions is not deployable by itself as it&rsquo;s missing the
<code>deployment.target</code> declaration, this allows us to deploy the same set
of servers to multiple targets such as VirtualBox and AWS.</p>

<h2 id="deployment">Deployment</h2>

<h3 id="virtualbox">VirtualBox</h3>

<p>To deploy to VirtualBox, simply create the file <code>vbox.nix</code> with the
following content</p>


<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-nix" data-lang="nix">{
  lb <span style="color:#f92672">=</span> { deployment<span style="color:#f92672">.</span>targetEnv <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;virtualbox&#34;</span>; };
  backend1 <span style="color:#f92672">=</span> { deployment<span style="color:#f92672">.</span>targetEnv <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;virtualbox&#34;</span>; };
  backend2 <span style="color:#f92672">=</span> { deployment<span style="color:#f92672">.</span>targetEnv <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;virtualbox&#34;</span>; };
}
</code></pre></div>

<p>Create a deployment by running <code>nixops create -d hw-vbox
servers.nix vbox.nix</code> and deploy it with <code>nixops deploy -d hw-vbox --force-reboot</code></p>

<p><strong>NOTE</strong> that the <code>--force-reboot</code> should only be specified the first
time the deployment was done. This is due to a <a href="https://github.com/NixOS/nixops/issues/908">known
bug</a>. This is not needed for
nixops &gt;= 1.6.2.</p>

<h3 id="aws">AWS</h3>

<p>We&rsquo;re going to deploy this configuration on AWS now</p>

    </div>
    
      <div class="pagination">
        <div class="pagination__title">
          <span class="pagination__title-h">Read other posts</span>
          <hr />
        </div>
        <div class="pagination__buttons">
          
          
            <span class="button next">
              <a href="https://kalbas.it/2016/08/21/setup-a-website-on-aws-with-coreos-and-docker/">
                <span class="button__text">Setup a website on AWS with CoreOS and Docker</span>
                <span class="button__icon">→</span>
              </a>
            </span>
          
        </div>
      </div>
    

    

  </div>

  </div>

  
    <footer class="footer">
  <div class="footer__inner">
    
      <div class="copyright">
        <span>© 2019 Powered by <a href="http://gohugo.io">Hugo</a></span>
        <span>:: Theme made by <a href="https://twitter.com/panr">panr</a></span>
      </div>
    
  </div>
</footer>

<script src="https://kalbas.it/assets/main.js"></script>
<script src="https://kalbas.it/assets/prism.js"></script>

  
</div>

</body>
</html>
